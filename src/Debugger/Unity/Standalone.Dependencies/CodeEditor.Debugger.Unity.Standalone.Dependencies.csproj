<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProductVersion>8.0.30703</ProductVersion>
    <SchemaVersion>2.0</SchemaVersion>
    <ProjectGuid>{367AD6BB-75DA-4B31-ADD9-E89F5E02BA45}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>CodeEditor.Debugger.Unity.Standalone.Dependencies</RootNamespace>
    <AssemblyName>CodeEditor.Debugger.Unity.Standalone.Dependencies</AssemblyName>
    <TargetFrameworkVersion>v4.0</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <SolutionDir Condition="'$(SolutionDir)' == ''">..\..\..\..\</SolutionDir>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="Mono.Cecil, Version=0.6.9.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>$(SolutionDir)..\Mono.Cecil\Mono.Cecil.dll</HintPath>
    </Reference>
    <Reference Include="Boo.OMeta, Version=1.0.4528.0, Culture=neutral, PublicKeyToken=32c39770e9a21a67, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>$(SolutionDir)libs\Boo.OMeta.dll</HintPath>
    </Reference>
    <Reference Include="CodeEditor.Grammars, Version=0.0.0.0, Culture=neutral, processorArchitecture=MSIL">
      <SpecificVersion>False</SpecificVersion>
      <HintPath>$(SolutionDir)libs\CodeEditor.Grammars.dll</HintPath>
    </Reference>
    <ProjectReference Include="..\Standalone\CodeEditor.Debugger.Unity.Standalone.csproj">
      <Project>{05848CF0-F1ED-4806-8A06-62B7AD048BE7}</Project>
      <Name>CodeEditor.Debugger.Unity.Standalone</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\Backend.Sdb\CodeEditor.Debugger.Backend.Sdb.csproj">
      <Project>{796B13D9-48B9-4EBA-B274-BBF297AFBD66}</Project>
      <Name>CodeEditor.Debugger.Backend.Sdb</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\Backend\CodeEditor.Debugger.Backend.csproj">
      <Project>{3C524BBD-42F2-4BF2-A96A-329A8C76F7F9}</Project>
      <Name>CodeEditor.Debugger.Backend</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)external\Mono.Debugger.Soft\Mono.Debugger.Soft.csproj">
      <Project>{F2D07F82-9C51-4889-8987-4CEF47490751}</Project>
      <Name>Mono.Debugger.Soft</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Frameworks\CodeEditor.Collections\CodeEditor.Collections.csproj">
      <Project>{59F47162-813F-47E0-9E62-99090D2081C1}</Project>
      <Name>CodeEditor.Collections</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Frameworks\CodeEditor.Composition\CodeEditor.Composition.csproj">
      <Project>{9DB8BFD3-06C8-4A8C-8842-5931B924B56C}</Project>
      <Name>CodeEditor.Composition</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Frameworks\CodeEditor.Remoting\CodeEditor.Remoting.csproj">
      <Project>{F3B4F98B-CC7D-4E3F-A8B6-FEA8E8C4A078}</Project>
      <Name>CodeEditor.Remoting</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Frameworks\CodeEditor.IO\CodeEditor.IO.csproj">
      <Project>{489773FF-92B1-40B0-98EF-3ED337E5448F}</Project>
      <Name>CodeEditor.IO</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Languages\CodeEditor.Languages.Boo\CodeEditor.Languages.Boo.csproj">
      <Project>{07D07B75-A60C-4063-8A0B-5A2F3C84490F}</Project>
      <Name>CodeEditor.Languages.Boo</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Languages\CodeEditor.Languages.Common\CodeEditor.Languages.Common.csproj">
      <Project>{80FD90AA-4188-4D81-AB31-6CDF792A84FA}</Project>
      <Name>CodeEditor.Languages.Common</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Languages\CodeEditor.Languages.CSharp\CodeEditor.Languages.CSharp.csproj">
      <Project>{81C749CC-09BF-4F72-B9C7-93D8446360DF}</Project>
      <Name>CodeEditor.Languages.CSharp</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Languages\CodeEditor.Languages.UnityScript\CodeEditor.Languages.UnityScript.csproj">
      <Project>{6EBD7F15-9B34-49BA-B50B-1AC51527D085}</Project>
      <Name>CodeEditor.Languages.UnityScript</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Services\CodeEditor.Remoting.Completion\CodeEditor.Remoting.Completion.csproj">
      <Project>{D5A79034-8547-44FD-98F2-0E8869C7D742}</Project>
      <Name>CodeEditor.Remoting.Completion</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Text\CodeEditor.Text.UI.Unity.Engine\CodeEditor.Text.UI.Unity.Engine.csproj">
      <Project>{C290F98D-894E-4878-AE4A-D1E83DA95619}</Project>
      <Name>CodeEditor.Text.UI.Unity.Engine</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Text\CodeEditor.Text.Data\CodeEditor.Text.Data.csproj">
      <Project>{A6107081-C1F6-4B9C-AFED-2BE0AB8E5BAF}</Project>
      <Name>CodeEditor.Text.Data</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Text\CodeEditor.Text.Logic\CodeEditor.Text.Logic.csproj">
      <Project>{E563745A-460A-4FBF-A72B-B2D4492A9716}</Project>
      <Name>CodeEditor.Text.Logic</Name>
    </ProjectReference>
    <ProjectReference Include="$(SolutionDir)src\Text\CodeEditor.Text.UI\CodeEditor.Text.UI.csproj">
      <Project>{6A91E197-9142-40C7-8C24-A75E8709E26D}</Project>
      <Name>CodeEditor.Text.UI</Name>
    </ProjectReference>
  </ItemGroup>
  <ItemGroup>
    <Compile Include="Empty.cs" />
  </ItemGroup>
  <ItemGroup>
    <Folder Include="Properties\" />
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <Import Project="$(SolutionDir)Unity.targets" />
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it.
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
  <PropertyGroup Condition=" '$(OS)' == 'Unix' ">
    <UnityBuildDir>$(UnityBuildRoot)MacEditor\</UnityBuildDir>
    <UnityCmd>$(UnityBuildDir)Unity.app\Contents\MacOS\Unity</UnityCmd>
    <UnityDebuggerProjectBuildDir>Build\Mac\</UnityDebuggerProjectBuildDir>
    <UnityDebuggerDir>Unity.app\Contents\Tools\Debugger\</UnityDebuggerDir>
    <UnityDebuggerDataDir>$(UnityDebuggerDir)Debugger.app\Contents\Data\Managed\</UnityDebuggerDataDir>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(OS)' != 'Unix' ">
    <UnityBuildDir>$(UnityBuildRoot)WindowsEditor\</UnityBuildDir>
    <UnityCmd>$(UnityBuildDir)Unity.exe</UnityCmd>
    <UnityDebuggerProjectBuildDir>Build\Windows\</UnityDebuggerProjectBuildDir>
    <UnityDebuggerDir>Data\Tools\Debugger\</UnityDebuggerDir>
    <UnityDebuggerDataDir>$(UnityDebuggerDir)Debugger_Data\Managed\</UnityDebuggerDataDir>
  </PropertyGroup>

  <Target Name="AfterBuild" DependsOnTargets="BuildDebugger" />

  <!-- Make sure all the assemblies are cleaned from the debugger dir as well -->
  <Target Name="AfterClean" DependsOnTargets="_ResolveOutputFiles">
    <Delete Files="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')" />
  </Target>

  <!-- This target resolves all the assemblies that this project references directly or
        indirectly, excluding the UnityEngine.dll and UnityEditor.dll -->
  <Target Name="_ResolveOutputFiles" DependsOnTargets="_ResolvePaths">

    <CreateItem
      Condition="'$(Configuration)' == 'Debug'"
      Include="$(OutDir)*.dll;$(OutDir)*.pdb"
      Exclude="$(OutDir)UnityEngine*;$(OutDir)UnityEditor*;$(OutDir)$(TargetFilename)">
      <Output TaskParameter="Include" ItemName="_Files" />
    </CreateItem>

    <CreateItem
      Condition="'$(Configuration)' != 'Debug'"
      Include="$(OutDir)*.dll"
      Exclude="$(OutDir)UnityEngine*;$(OutDir)UnityEditor*;$(OutDir)$(TargetFilename)">
      <Output TaskParameter="Include" ItemName="_Files" />
    </CreateItem>

    <Message Text="@(_Files)" Importance="Low" />

  </Target>

  <!-- This target resolves all the debugger player files -->
  <Target Name="_ResolveOutputDebugger" DependsOnTargets="_ResolvePaths">
    <CreateItem Include="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)**">
      <Output TaskParameter="Include" ItemName="_DebuggerFiles" />
    </CreateItem>

    <Message Text="Debugger Files: @(_DebuggerFiles)" Importance="Low" />
  </Target>

  <!-- This target resolves full project and tool paths for the _BuildDebuggerProject target -->
  <Target Name="_ResolvePaths">

    <!-- This allows us to later get the full path by doing %(UnityDebuggerProjectDir.FullPath) -->
    <CreateItem Include="..\Standalone\UnityProject\">
      <Output TaskParameter="Include" ItemName="UnityDebuggerProjectDir" />
    </CreateItem>

    <CreateProperty Value="%(UnityDebuggerProjectDir.FullPath)">
      <Output TaskParameter="Value" PropertyName="_ProjectAbsPath" />
    </CreateProperty>

    <CreateProperty Value="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger.app" Condition="'$(OS)'=='Unix'">
      <Output TaskParameter="Value" PropertyName="_DebuggerExe" />
    </CreateProperty>

    <CreateProperty Value="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger.exe" Condition="'$(OS)'!='Unix'">
      <Output TaskParameter="Value" PropertyName="_DebuggerExe" />
    </CreateProperty>

    <CreateProperty Value="$(UnityCmd) -buildOSXPlayer &quot;$(_DebuggerExe)&quot;" Condition="'$(OS)'=='Unix'">
      <Output TaskParameter="Value" PropertyName="_UnityCmd" />
    </CreateProperty>

    <CreateProperty Value="$(UnityCmd) -buildWindowsPlayer &quot;$(_DebuggerExe)&quot;" Condition="'$(OS)'!='Unix'">
      <Output TaskParameter="Value" PropertyName="_UnityCmd" />
    </CreateProperty>

  </Target>


  <!-- Take all the assemblies and copy them to the debugger dir,
        with dependency checks (only copies what's changed) -->
  <Target Name="_CopyDependenciesToDebuggerDir" DependsOnTargets="_ResolveOutputFiles"
    Inputs="@(_Files)" Outputs="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')">

    <MakeDir Directories="$(UnityBuildDir)$(UnityDebuggerDataDir)" />

    <Copy
      SourceFiles="@(_Files)"
      DestinationFolder="$(UnityBuildDir)$(UnityDebuggerDataDir)"
      SkipUnchangedFiles="true" />
    <!-- Touch Files="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')" /-->
  </Target>

  <Target Name="_SetupDebuggerProject" DependsOnTargets="_ResolveOutputFiles">

    <!-- MakeDir Directories="$(_ProjectAbsPath)Project\Assets\bin" / -->
    <MakeDir Directories="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)" />

    <ItemGroup>
      <_ToDelete
        Include="$(_ProjectAbsPath)Project\Assets\bin\*.dll;$(_ProjectAbsPath)Project\Assets\bin\*.pdb"
        Exclude="@(_Files->'$(_ProjectAbsPath)Project\Assets\bin\%(RecursiveDir)%(Filename)%(Extension)')"
        />
    </ItemGroup>

    <Copy
      SourceFiles="@(_Files)"
      DestinationFolder="$(_ProjectAbsPath)Project\Assets\bin"
      SkipUnchangedFiles="true"/>

    <Delete Files="@(_ToDelete)" />

  </Target>

  <!-- This target is called by the BuildDebuggerProject target. It builds the unity debugger
       project and deploys the result to the proper directories -->
  <Target Name="_BuildDebuggerProject" DependsOnTargets="_SetupDebuggerProject"
    Inputs="@(_Files)"
    Outputs="$(_DebuggerExe)">

    <Exec Command="$(_UnityCmd) -batchmode -projectpath &quot;$(_ProjectAbsPath)Project&quot; -quit" />
    <Touch Files="$(_DebuggerExe)" />

    <!-- Clean out files that aren't needed anymore -->
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\CodeEditor.*" />
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\Mono.Debugger.Soft.dll" />
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\Mono.Cecil.dll" />
    <Delete Files="$(_ProjectAbsPath)Project\Assets\bin" />
  </Target>

  <Target Name="_CopyDebuggerBuild" DependsOnTargets="_ResolveOutputFiles;_ResolveOutputDebugger"
    Inputs="@(_Files->'$(_ProjectAbsPath)Project\Assets\bin\%(RecursiveDir)%(Filename)%(Extension)');@(_DebuggerFiles)"
    Outputs="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(RecursiveDir)%(Filename)%(Extension)');@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')">

    <Copy
      SourceFiles="@(_Files)"
      DestinationFiles="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(RecursiveDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="true" />

    <Copy
      SourceFiles="@(_DebuggerFiles)"
      DestinationFiles="@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="true" />

    <!--Touch Files="@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')" /-->

  </Target>

  <Target Name="Deploy" DependsOnTargets="Build" />
  <Target Name="DeployDebugger" DependsOnTargets="_CopyDebuggerBuild;_CopyDependenciesToDebuggerDir" />
  <Target Name="BuildDebugger" DependsOnTargets="_BuildDebuggerProject;DeployDebugger" />

</Project>