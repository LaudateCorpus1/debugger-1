<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <ProductVersion>8.0.30703</ProductVersion>
    <SchemaVersion>2.0</SchemaVersion>
    <ProjectGuid>{367AD6BB-75DA-4B31-ADD9-E89F5E02BA45}</ProjectGuid>
    <OutputType>Library</OutputType>
    <AppDesignerFolder>Properties</AppDesignerFolder>
    <RootNamespace>CodeEditor.Debugger.Unity.Standalone.Dependencies</RootNamespace>
    <AssemblyName>CodeEditor.Debugger.Unity.Standalone.Dependencies</AssemblyName>
    <TargetFrameworkVersion>v4.0</TargetFrameworkVersion>
    <FileAlignment>512</FileAlignment>
    <SolutionDir Condition="'$(SolutionDir)' == ''">..\..\..\..\</SolutionDir>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <DebugSymbols>true</DebugSymbols>
    <DebugType>full</DebugType>
    <Optimize>false</Optimize>
    <OutputPath>bin\Debug\</OutputPath>
    <DefineConstants>DEBUG;TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <DebugType>pdbonly</DebugType>
    <Optimize>true</Optimize>
    <OutputPath>bin\Release\</OutputPath>
    <DefineConstants>TRACE</DefineConstants>
    <ErrorReport>prompt</ErrorReport>
    <WarningLevel>4</WarningLevel>
  </PropertyGroup>
  <ItemGroup>
    <ProjectReference Include="..\Standalone\CodeEditor.Debugger.Unity.Standalone.csproj">
      <Project>{05848CF0-F1ED-4806-8A06-62B7AD048BE7}</Project>
      <Name>CodeEditor.Debugger.Unity.Standalone</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\..\Languages\CodeEditor.Languages.Boo\CodeEditor.Languages.Boo.csproj">
      <Project>{07D07B75-A60C-4063-8A0B-5A2F3C84490F}</Project>
      <Name>CodeEditor.Languages.Boo</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\..\Languages\CodeEditor.Languages.Common\CodeEditor.Languages.Common.csproj">
      <Project>{80FD90AA-4188-4D81-AB31-6CDF792A84FA}</Project>
      <Name>CodeEditor.Languages.Common</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\..\Languages\CodeEditor.Languages.CSharp\CodeEditor.Languages.CSharp.csproj">
      <Project>{81C749CC-09BF-4F72-B9C7-93D8446360DF}</Project>
      <Name>CodeEditor.Languages.CSharp</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\..\Languages\CodeEditor.Languages.UnityScript\CodeEditor.Languages.UnityScript.csproj">
      <Project>{6EBD7F15-9B34-49BA-B50B-1AC51527D085}</Project>
      <Name>CodeEditor.Languages.UnityScript</Name>
    </ProjectReference>
    <ProjectReference Include="..\..\..\Text\CodeEditor.Text.UI.Unity.Engine\CodeEditor.Text.UI.Unity.Engine.csproj">
      <Project>{C290F98D-894E-4878-AE4A-D1E83DA95619}</Project>
      <Name>CodeEditor.Text.UI.Unity.Engine</Name>
    </ProjectReference>
  </ItemGroup>
  <ItemGroup>
    <Compile Include="Empty.cs" />
  </ItemGroup>
  <ItemGroup>
    <Folder Include="Properties\" />
  </ItemGroup>
  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
  <Import Project="$(SolutionDir)Unity.targets" />
  <!-- To modify your build process, add your task inside one of the targets below and uncomment it.
       Other similar extension points exist, see Microsoft.Common.targets.
  <Target Name="BeforeBuild">
  </Target>
  <Target Name="AfterBuild">
  </Target>
  -->
  <PropertyGroup Condition=" '$(OS)' == 'Unix' ">
    <UnityBuildDir>$(UnityBuildRoot)MacEditor\</UnityBuildDir>
    <UnityCmd>$(UnityBuildDir)Unity.app\Contents\MacOS\Unity</UnityCmd>
    <UnityDebuggerProjectBuildDir>Build\Mac\</UnityDebuggerProjectBuildDir>
    <UnityDebuggerDir>Unity.app\Contents\Tools\Debugger\</UnityDebuggerDir>
    <UnityDebuggerDataDir>$(UnityDebuggerDir)Debugger.app\Contents\Data\Managed\</UnityDebuggerDataDir>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(OS)' != 'Unix' ">
    <UnityBuildDir>$(UnityBuildRoot)WindowsEditor\</UnityBuildDir>
    <UnityCmd>$(UnityBuildDir)Unity.exe</UnityCmd>
    <UnityDebuggerProjectBuildDir>Build\Windows\</UnityDebuggerProjectBuildDir>
    <UnityDebuggerDir>Data\Tools\Debugger\</UnityDebuggerDir>
    <UnityDebuggerDataDir>$(UnityDebuggerDir)Debugger_Data\Managed\</UnityDebuggerDataDir>
  </PropertyGroup>

  <!-- Since xbuild invokes the compiler even when the project has no source files,
      make sure the build step is skipped by touching the project output assembly here -->
  <Target Name="BeforeBuild">
    <MakeDir Directories="$(IntermediateOutputPath)" />
    <Touch Files="@(IntermediateAssembly)" AlwaysCreate="true" />
  </Target>

  <Target Name="AfterBuild" DependsOnTargets="DeployDebugger" />

  <!-- Make sure all the assemblies are cleaned from the debugger dir as well -->
  <Target Name="AfterClean" DependsOnTargets="_ResolveOutputFiles">
    <Delete Files="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')" />
  </Target>

  <!-- This target resolves all the assemblies that this project references directly or
        indirectly, excluding the UnityEngine.dll and UnityEditor.dll -->
  <Target Name="_ResolveOutputFiles" DependsOnTargets="_ResolvePaths">

    <CreateItem
      Condition="'$(Configuration)' == 'Debug'"
      Include="$(OutDir)*.dll;$(OutDir)*.pdb"
      Exclude="$(OutDir)UnityEngine*;$(OutDir)UnityEditor*;$(OutDir)$(TargetFilename)">
      <Output TaskParameter="Include" ItemName="_Files" />
    </CreateItem>

    <CreateItem
      Condition="'$(Configuration)' != 'Debug'"
      Include="$(OutDir)*.dll"
      Exclude="$(OutDir)UnityEngine*;$(OutDir)UnityEditor*;$(OutDir)$(TargetFilename)">
      <Output TaskParameter="Include" ItemName="_Files" />
    </CreateItem>

    <Message Text="@(_Files)" Importance="Low" />

  </Target>

  <!-- This target resolves all the debugger player files -->
  <Target Name="_ResolveOutputDebugger" DependsOnTargets="_ResolvePaths">
    <CreateItem Include="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)**">
      <Output TaskParameter="Include" ItemName="_DebuggerFiles" />
    </CreateItem>

    <Message Text="Debugger Files: @(_DebuggerFiles)" Importance="Low" />
  </Target>

  <!-- This target resolves full project and tool paths for the _BuildDebuggerProject target -->
  <Target Name="_ResolvePaths">

    <!-- This allows us to later get the full path by doing %(UnityDebuggerProjectDir.FullPath) -->
    <CreateItem Include="..\Standalone\UnityProject\">
      <Output TaskParameter="Include" ItemName="UnityDebuggerProjectDir" />
    </CreateItem>

    <CreateProperty Value="%(UnityDebuggerProjectDir.FullPath)">
      <Output TaskParameter="Value" PropertyName="_ProjectAbsPath" />
    </CreateProperty>

    <CreateProperty Value="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger.app" Condition="'$(OS)'=='Unix'">
      <Output TaskParameter="Value" PropertyName="_DebuggerExe" />
    </CreateProperty>

    <CreateProperty Value="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger.exe" Condition="'$(OS)'!='Unix'">
      <Output TaskParameter="Value" PropertyName="_DebuggerExe" />
    </CreateProperty>

    <CreateProperty Value="$(UnityCmd) -buildOSXPlayer &quot;$(_DebuggerExe)&quot;" Condition="'$(OS)'=='Unix'">
      <Output TaskParameter="Value" PropertyName="_UnityCmd" />
    </CreateProperty>

    <CreateProperty Value="$(UnityCmd) -buildWindowsPlayer &quot;$(_DebuggerExe)&quot;" Condition="'$(OS)'!='Unix'">
      <Output TaskParameter="Value" PropertyName="_UnityCmd" />
    </CreateProperty>

  </Target>


  <!-- Take all the assemblies and copy them to the debugger dir,
        with dependency checks (only copies what's changed) -->
  <Target Name="_CopyDependenciesToDebuggerDir" DependsOnTargets="_ResolveOutputFiles"
    Inputs="@(_Files)" Outputs="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')">

    <MakeDir Directories="$(UnityBuildDir)$(UnityDebuggerDataDir)" />

    <Copy
      SourceFiles="@(_Files)"
      DestinationFolder="$(UnityBuildDir)$(UnityDebuggerDataDir)"
      SkipUnchangedFiles="true" />

    <Touch Files="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(Filename)%(Extension)')" />

  </Target>

  <Target Name="_SetupDebuggerProject" DependsOnTargets="_ResolveOutputFiles"
    Inputs="@(_Files)"
    Outputs="@(_Files->'$(_ProjectAbsPath)Project\Assets\bin\%(RecursiveDir)%(Filename)%(Extension)')">

    <MakeDir Directories="$(_ProjectAbsPath)Project\Assets\bin" />
    <MakeDir Directories="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)" />
    <Copy SourceFiles="@(_Files)" DestinationFolder="$(_ProjectAbsPath)Project\Assets\bin" />

  </Target>

  <!-- This target is called by the BuildDebuggerProject target. It builds the unity debugger
       project and deploys the result to the proper directories -->
  <Target Name="_BuildDebuggerProject" DependsOnTargets="_SetupDebuggerProject"
      Inputs="@(_Files->'$(_ProjectAbsPath)Project\Assets\bin\%(RecursiveDir)%(Filename)%(Extension)')"
      Outputs="$(_DebuggerExe)">

    <Exec Command="$(_UnityCmd) -batchmode -projectpath &quot;$(_ProjectAbsPath)Project&quot; -quit" />

    <!-- Clean out files that aren't needed anymore -->
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\CodeEditor.*" />
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\Mono.Debugger.Soft.dll" />
    <Delete Files="$(_ProjectAbsPath)$(UnityDebuggerProjectBuildDir)Debugger_Data\Managed\Mono.Cecil.dll" />
    <Delete Files="$(_ProjectAbsPath)Project\Assets\bin" />
  </Target>

  <Target Name="_CopyDebuggerBuild" DependsOnTargets="_ResolveOutputFiles;_ResolveOutputDebugger"
    Inputs="@(_Files->'$(_ProjectAbsPath)Project\Assets\bin\%(RecursiveDir)%(Filename)%(Extension)');@(_DebuggerFiles)"
    Outputs="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(RecursiveDir)%(Filename)%(Extension)');@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')">

    <Copy
      SourceFiles="@(_Files)"
      DestinationFiles="@(_Files->'$(UnityBuildDir)$(UnityDebuggerDataDir)%(RecursiveDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="true" />

    <Copy
      SourceFiles="@(_DebuggerFiles)"
      DestinationFiles="@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')"
      SkipUnchangedFiles="true" />

    <!--Touch Files="@(_DebuggerFiles->'$(UnityBuildDir)$(UnityDebuggerDir)%(RecursiveDir)%(Filename)%(Extension)')" /-->

  </Target>

  <Target Name="Deploy" DependsOnTargets="Build" />
  <Target Name="DeployDebugger" DependsOnTargets="_CopyDebuggerBuild;_CopyDependenciesToDebuggerDir" />
  <Target Name="BuildDebugger" DependsOnTargets="_BuildDebuggerProject;DeployDebugger" />

</Project>